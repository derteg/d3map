<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Accidents on the Road - Choropleth</title>
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
  <script type="text/javascript" src="http://d3js.org/topojson.v0.min.js"></script>
  <!--script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script -->
</head>
<style>
	path {
	  stroke:white;
	  stroke-width: 1px;
	}

	body {
	  font-family: Arial, sans-serif;
	}

	.station {
	  font: 10px sans-serif;
	  font-weight: bold;
	}

	.legend {
	  font-size: 12px;
	}

	div.tooltip {   
	  position: absolute;           
	  text-align: center;           
	  width: 150px;                  
	  height: 25px;                 
	  padding: 2px;             
	  font-size: 10px;     
	  background: #FFFFE0;
	  border: 1px;      
	  border-radius: 8px;           
	  pointer-events: none;         
	}        
</style>
<body>
  <script type="text/javascript">
	var width = 1200,
		height = 500,
		region,
		region,
		station,
		stationData,
		centered,
		scale0 = (width - 1) / 2;

	// Setting color domains(intervals of values) for our map
	var color_domain = [50, 100, 150, 200, 250, 300, 350];
	var color = d3.scale.threshold()
		.domain(color_domain)
		.range(["#3fb8ff", "#68cafd", "#3fb8ff", "#3fb8ff", "#aee4ff", "#0099ff", "#68cafd", "#087cdf"]);

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height)
		.attr("class", "map-energy__svg");

	var projection = d3.geo.albers()
		.rotate([-105, 0])
		.center([-10, 65])
		.parallels([52, 64])
		.scale(700)
		.translate([width / 2, height / 2]);

	var path = d3.geo.path().projection(projection);

	var regions = svg.append("g")
			.attr("class", "region");

	//Reading map file and data
	queue()
		.defer(d3.json, "russia_topo.json")
		.defer(d3.csv, "Accidents.csv")
		.defer(d3.tsv, "cities.tsv")
		.await(ready);

	//Start of Choropleth drawing
	function ready(error, map, data1, data2) {
		var rateById = {};
		var nameById = {};

		data1.forEach(function(d) {
			rateById[d.RegionCode] = d.Color;
			nameById[d.RegionCode] = d.RegionName;
		});

		//Drawing Choropleth
		region = regions.selectAll("path")
			.data(topojson.object(map, map.objects.name).geometries)
			.enter().append("path")
			.attr("d", path)
			.style("stroke-width", "0")
			.style("fill", function(d) {
				return rateById[d.properties.region];
			})
			.style("opacity", 1)
			.on("mouseover", function(d) {
				d3.select(this).transition().duration(300).style("opacity", 0.95);
			})
			.on("mouseout", function() {
				d3.select(this)
					.transition().duration(300)
					.style("opacity", 1);
			});

		station = svg.selectAll("g.station")
			.data(data2)
			.enter()
			.append("g")
			.attr("class", "station")
			.attr("transform", function(d) {
				return "translate(" + projection([d.lon, d.lat]) + ")";
			});


		station.append("circle")
			.attr("r", 13)
			.style("fill", "#cce4f9")
			.style("stroke", "white")
			.style("stroke-width", "2px")

		station.append('svg:image')
			.attr('x',-11)
			.attr('y',-11)
			.attr('width', 22)
			.attr('height', 22)
			.attr("xlink:href", function(d) {return d.Type})
			.style("cursor", "pointer");

		// regions.selectAll("path").on("click", zoomed2);

		// function zoomed2(d) {
		// 	var x, y, k;

		// 	if (d && centered !== d) {
		// 		var centroid = path.centroid(d);
		// 		x = centroid[0];
		// 		y = centroid[1];
		// 		k = 4;
		// 		centered = d;
		// 	} else {
		// 		x = width / 2;
		// 		y = height / 2;
		// 		k = 1;
		// 		centered = null;
		// 	}

		// 	regions.transition()
		//       .duration(750)
		//       .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
		//       .style("stroke-width", 1.5 / k + "px");
		// }

		var zoom = d3.behavior.zoom()
		.translate([width / 2, height / 2])
		.scale(scale0)
		.scaleExtent([scale0, 2 * scale0]) // минимальное и максимальное значения для зума.
		.on("zoom", zoomed);

		svg
			.call(zoom)
			.call(zoom.event);

		function zoomed() {
			projection
				.translate(zoom.translate())
				.scale(zoom.scale());
			
			regions.selectAll("path")
				.attr("d", path);

			svg.selectAll("g.station")
				.attr("transform", function(d) {
					return "translate(" + projection([d.lon, d.lat]) + ")";
				});
		}
	};	// <-- End of Choropleth drawing
  </script>
</body>
</html>